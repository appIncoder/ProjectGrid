<div class="card flex-fill">
  <div class="card-body">

    <!-- Header + contrôles période -->
    <div class="d-flex align-items-center justify-content-between mb-2 gap-2 flex-wrap">
      <h3 class="h6 mb-0">Roadmap – Diagramme de Gantt ({{ getPeriodLabel() }})</h3>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <select
          class="form-select form-select-sm"
          style="width: 170px;"
          [ngModel]="periodPreset"
          (ngModelChange)="onPeriodPresetChange($event)"
        >
          <option value="3m">3 mois</option>
          <option value="6m">6 mois</option>
          <option value="12m">1 an</option>
          <option value="custom">Période custom</option>
        </select>

        <div *ngIf="periodPreset === 'custom'" class="d-flex align-items-center gap-2 flex-wrap">
          <input
            type="date"
            class="form-control form-control-sm"
            style="width: 165px;"
            [(ngModel)]="customStartIso"
          />
          <input
            type="number"
            class="form-control form-control-sm"
            style="width: 110px;"
            min="1"
            max="60"
            [(ngModel)]="customMonths"
            placeholder="Mois"
          />
          <button class="btn btn-sm btn-outline-primary" (click)="applyCustomPeriod()">
            Appliquer
          </button>
        </div>

        <button class="btn btn-sm btn-primary" (click)="centerOnToday()">
          Centrer sur aujourd&apos;hui
        </button>
      </div>
    </div>

    <!-- Scroll VERTICAL global uniquement -->
    <div
      style="
        max-height: 560px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        background: #fff;
      "
    >
      <!-- Layout principal : tableau (viewport) + divider + gantt (viewport) -->
      <div
        style="
          display: grid;
          grid-template-columns: {{tablePanelWidthPx}}px {{dividerW}}px 1fr;
          align-items: start;
          background: #fff;
          font-size: 0.72rem;
          line-height: 1.12;
        "
      >
        <!-- =======================
             PANNEAU TABLEAU (scroll X indépendant)
             ======================= -->
        <div style="overflow-x: auto; overflow-y: hidden;">
          <div
            [style.gridTemplateColumns]="tableInnerGridTemplate"
            style="display: grid; width: max-content; min-width: 100%;"
          >
            <!-- ROW 1 tableau vide -->
            <div style="grid-column: 1 / span 5; height: 44px;"></div>

            <!-- ROW 2 : titres -->
            <div style="height: 32px; display:flex; align-items:center; min-width: 220px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">
              Tâches
            </div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">
              Début
            </div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">
              Fin
            </div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 300px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">
              Phase
            </div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">
              Progression
            </div>

            <!-- BODY -->
            <ng-container *ngFor="let row of ganttActivityRows">
              <!-- Col1 -->
              <div
                style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;"
                [style.fontWeight]="row.isHeader ? '600' : '400'"
              >
                <span *ngIf="row.isHeader" style="cursor:pointer;" (click)="onRowLabelClick(row)">
                  {{ getRowDisplayLabel(row) }}
                </span>

                <span *ngIf="!row.isHeader" style="padding-left: 12px;">
                  <span class="text-muted me-1">•</span>
                  {{ getRowTask(row.rowIndex)?.label ?? '' }}
                </span>
              </div>

              <!-- Col2 : Début -->
<div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5; overflow:hidden;">
                <ng-container *ngIf="getRowTask(row.rowIndex) as t; else dash1">
                  <div style="display:flex; flex-direction:column;">
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      style="width: 100%;"
                      [class.is-invalid]="!!tableDateErrors[t.id]"
                      [value]="getTaskStartIsoForTable(t)"
                      (change)="onTableStartDateChange(t, ($any($event.target).value))"
                    />
                    <div *ngIf="tableDateErrors[t.id]" class="invalid-feedback d-block">
                      {{ tableDateErrors[t.id] }}
                    </div>
                  </div>
                </ng-container>
                <ng-template #dash1><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col3 : Fin -->
<div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5; overflow:hidden;">
                <ng-container *ngIf="getRowTask(row.rowIndex) as t; else dash2">
                  <div style="display:flex; flex-direction:column;">
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      style="width: 100%;"
                      [class.is-invalid]="!!tableDateErrors[t.id]"
                      [value]="getTaskEndIsoForTable(t)"
                      (change)="onTableEndDateChange(t, ($any($event.target).value))"
                    />
                    <div *ngIf="tableDateErrors[t.id]" class="invalid-feedback d-block">
                      {{ tableDateErrors[t.id] }}
                    </div>
                  </div>
                </ng-container>
                <ng-template #dash2><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col4 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <span *ngIf="getRowTask(row.rowIndex) as t; else dash3">{{ t.phase }}</span>
                <ng-template #dash3><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col5 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <ng-container *ngIf="getRowTask(row.rowIndex) as t; else dash4">
                  <div class="d-flex align-items-center gap-2 w-100">
                    <div class="progress flex-grow-1" style="height: 8px; min-width: 70px;">
                      <div
                        class="progress-bar"
                        role="progressbar"
                        [style.width.%]="getTaskProgressPercent(t)"
                        [attr.aria-valuenow]="getTaskProgressPercent(t)"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                    <span class="small text-muted" style="min-width: 3ch; text-align:right;">
                      {{ getTaskProgressPercent(t) }}%
                    </span>
                  </div>
                </ng-container>
                <ng-template #dash4><span class="text-muted">—</span></ng-template>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- =======================
             DIVIDER (draggable)
             ======================= -->
        <div style="position: relative; height: 100%; background:#fff;">
          <div style="position:absolute; left: 4px; top:0; bottom:0; width:1px; background:#e9ecef;"></div>
          <div
            title="Glisser (min = 25% écran). Ensuite, scrolle le tableau."
            (pointerdown)="onResizeHandlePointerDown($event)"
            style="
              position:absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 10px;
              cursor: col-resize;
              background: rgba(13,110,253,0.06);
            "
          ></div>
        </div>

        <!-- =======================
             PANNEAU GANTT (scroll X indépendant)
             ======================= -->
        <div #ganttScroll style="overflow-x: auto; overflow-y: hidden;">
          <div style="width: max-content; min-width: 100%;">
            <!-- Row 1 : milestones + phases -->
            <svg class="gantt-svg" [attr.width]="ganttViewportWidth" [attr.height]="headerRow1Height" style="display:block;">
              <defs>
                <marker
                  id="ganttArrow"
                  viewBox="0 0 10 10"
                  refX="9"
                  refY="5"
                  markerWidth="6"
                  markerHeight="6"
                  orient="auto"
                >
                  <path d="M 0 0 L 10 5 L 0 10 z"></path>
                </marker>
              </defs>

              <g *ngFor="let ms of ganttMilestones">
                <circle
                  class="gantt-milestone-dot"
                  [attr.cx]="ganttLeftPadding + ms.monthIndex * ganttColWidth + ganttColWidth / 2"
                  [attr.cy]="18"
                  r="4"></circle>
                <text
                  class="gantt-milestone-text"
                  [attr.x]="ganttLeftPadding + ms.monthIndex * ganttColWidth + ganttColWidth / 2"
                  [attr.y]="12"
                  style="font-size: 0.58rem;"
                >
                  {{ ms.label }}
                </text>
              </g>

              <g *ngFor="let band of ganttPhaseBands">
                <rect
                  class="gantt-phase-band"
                  [attr.x]="ganttLeftPadding + band.startMonthIndex * ganttColWidth"
                  [attr.y]="28"
                  [attr.width]="(band.endMonthIndex - band.startMonthIndex + 1) * ganttColWidth"
                  [attr.height]="10"></rect>
                <text
                  class="gantt-phase-text"
                  [attr.x]="ganttLeftPadding + (band.startMonthIndex + band.endMonthIndex + 1) * ganttColWidth / 2"
                  [attr.y]="40"
                  style="font-size: 0.58rem;"
                >
                  {{ band.label }}
                </text>
              </g>
            </svg>

            <!-- Row 2 : mois -->
            <svg class="gantt-svg" [attr.width]="ganttViewportWidth" [attr.height]="headerRow2Height" style="display:block;">
              <g *ngFor="let month of ganttMonths; index as i">
                <text
                  class="gantt-month-text"
                  [attr.x]="ganttLeftPadding + i * ganttColWidth + ganttColWidth / 2"
                  [attr.y]="20"
                  style="font-size: 0.60rem; font-weight:600;"
                >
                  {{ month }}
                </text>
              </g>
            </svg>

            <!-- Body -->
            <svg
              class="gantt-svg"
              [attr.width]="ganttViewportWidth"
              [attr.height]="ganttBodyHeight"
              style="display:block;"
              (mousemove)="onGanttMouseMove($event)"
              (mouseup)="onGanttMouseUp($event)"
              (mouseleave)="onGanttMouseUp($event)"
            >
              <defs>
                <marker
                  id="ganttArrowBody"
                  viewBox="0 0 10 10"
                  refX="9"
                  refY="5"
                  markerWidth="6"
                  markerHeight="6"
                  orient="auto"
                >
                  <path d="M 0 0 L 10 5 L 0 10 z"></path>
                </marker>
              </defs>

              <!-- Grille verticale (mois) -->
              <g *ngFor="let m of ganttMonths; index as colIndex">
                <line
                  class="gantt-grid-line"
                  [attr.x1]="ganttLeftPadding + colIndex * ganttColWidth"
                  [attr.y1]="0"
                  [attr.x2]="ganttLeftPadding + colIndex * ganttColWidth"
                  [attr.y2]="ganttBodyHeight"></line>
              </g>

              <!-- Grille horizontale (lignes) -->
              <g *ngFor="let r of ganttActivityRows">
                <line
                  class="gantt-row-line"
                  [attr.x1]="0"
                  [attr.y1]="r.rowIndex * bodyRowHeight"
                  [attr.x2]="ganttViewportWidth"
                  [attr.y2]="r.rowIndex * bodyRowHeight"></line>
              </g>

              <!-- Ligne Today -->
              <g *ngIf="todayDayIndex !== null">
                <line
                  [attr.x1]="ganttLeftPadding + todayDayIndex * dayWidth"
                  [attr.y1]="0"
                  [attr.x2]="ganttLeftPadding + todayDayIndex * dayWidth"
                  [attr.y2]="ganttBodyHeight"
                  style="stroke: #0d6efd; stroke-width: 1; stroke-dasharray: 4 4;"
                ></line>
                <text
                  [attr.x]="ganttLeftPadding + todayDayIndex * dayWidth + 6"
                  [attr.y]="14"
                  style="font-size: 0.62rem; font-weight: 600; fill: #0d6efd;"
                >
                  Today
                </text>
              </g>

              <!-- ✅ Liens (hover + focus + filtre) -->
<!-- Liens -->
<g *ngFor="let link of ganttLinksView">
  <path
    [attr.class]="getLinkCssClass(link)"
    [attr.d]="link.path"
    marker-end="url(#ganttArrowBody)"
    (mouseenter)="onLinkMouseEnter(link)"
    (mouseleave)="onLinkMouseLeave()"
  ></path>
</g>

<!-- Tâches -->
<g *ngFor="let task of ganttTasksView">
  <!-- rect + bullets + label -->
</g>

<!-- Hints dates -->
<g *ngIf="hoverHints.start as hs">…</g>
<g *ngIf="hoverHints.end as he">…</g>

<!-- ✅ TOOLTIP LIEN : TOUJOURS EN DERNIER -->
<g *ngIf="linkTooltip as lt">
  <rect
    class="gantt-link-tooltip-bg"
    [attr.x]="lt.x - 160"
    [attr.y]="lt.y - 18"
    rx="6"
    ry="6"
    width="320"
    height="24"
  ></rect>
  <text
    class="gantt-link-tooltip-text"
    [attr.x]="lt.x - 152"
    [attr.y]="lt.y - 2"
  >
    {{ lt.text }}
  </text>
</g>

<!-- Tooltip lien (hover) -->
<g *ngIf="linkTooltip as lt">
  <rect
    class="gantt-link-tooltip-bg"
    [attr.x]="lt.x - 160"
    [attr.y]="lt.y - 18"
    rx="6"
    ry="6"
    width="320"
    height="24"
  ></rect>
  <text
    class="gantt-link-tooltip-text"
    [attr.x]="lt.x - 152"
    [attr.y]="lt.y - 2"
  >
    {{ lt.text }}
  </text>
</g>

              <!-- Tâches -->
              <g *ngFor="let task of ganttTasksView">
                <rect
                  [attr.class]="
                    (task.id.startsWith('summary-') ? 'gantt-bar gantt-bar-summary' : 'gantt-bar')
                    + (isTaskHighlighted(task.id) ? ' gantt-bar--highlight' : '')
                    + (isTaskDimmed(task.id) ? ' gantt-bar--dim' : '')
                  "
                  [attr.x]="task.x"
                  [attr.y]="task.y"
                  [attr.width]="task.width"
                  [attr.height]="task.height"
                  (mousedown)="onGanttBarMouseDown($event, task)"
                ></rect>

                <!-- bullet gauche = move -->
                <circle
                  [attr.class]="
                    'gantt-bar-bullet gantt-bar-bullet-start'
                    + (isTaskHighlighted(task.id) ? ' gantt-bullet--highlight' : '')
                    + (isTaskDimmed(task.id) ? ' gantt-bullet--dim' : '')
                  "
                  [attr.cx]="task.x"
                  [attr.cy]="task.y + task.height / 2"
                  r="4"
                  (mousedown)="onGanttBarMouseDown($event, task)"
                  (mouseenter)="showHintForTask(task, 'start')"
                  (mouseleave)="hideHints()"
                ></circle>

                <!-- bullet droit = resize fin -->
                <circle
                  [attr.class]="
                    'gantt-bar-bullet gantt-bar-bullet-end'
                    + (isTaskHighlighted(task.id) ? ' gantt-bullet--highlight' : '')
                    + (isTaskDimmed(task.id) ? ' gantt-bullet--dim' : '')
                  "
                  [attr.cx]="task.x + task.width"
                  [attr.cy]="task.y + task.height / 2"
                  r="4"
                  (mousedown)="onGanttBarResizeEndMouseDown($event, task)"
                  (mouseenter)="showHintForTask(task, 'end')"
                  (mouseleave)="hideHints()"
                ></circle>

                <text
                  class="gantt-bar-label"
                  [attr.x]="task.x + 4"
                  [attr.y]="task.y + task.height / 2 + 4"
                  style="font-size: 0.60rem;"
                >
                  {{ task.label }}
                </text>
              </g>

              <!-- hints -->
              <g *ngIf="hoverHints.start as hs">
                <rect class="gantt-hint-bg" [attr.x]="hs.x" [attr.y]="hs.y - 18" rx="3" ry="3" width="90" height="20"></rect>
                <text class="gantt-hint-text" [attr.x]="hs.x + 4" [attr.y]="hs.y - 5" style="font-size: 0.60rem;">
                  {{ hs.text }}
                </text>
              </g>

              <g *ngIf="hoverHints.end as he">
                <rect class="gantt-hint-bg" [attr.x]="he.x" [attr.y]="he.y - 18" rx="3" ry="3" width="90" height="20"></rect>
                <text class="gantt-hint-text" [attr.x]="he.x + 4" [attr.y]="he.y - 5" style="font-size: 0.60rem;">
                  {{ he.text }}
                </text>
              </g>
            </svg>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ✅ Modal Roadmap : même popup + dépendances + filtre d’affichage des liens -->
<ng-template #taskEditModal let-modal>
  <div class="modal-header py-2">
    <h5 class="modal-title fs-6">Modifier l’activité</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div *ngIf="editError" class="alert alert-danger py-2 small mb-3">
      {{ editError }}
    </div>

    <!-- Nom -->
    <div class="mb-3">
      <label class="form-label form-label-sm">Nom de l’activité</label>
      <input class="form-control form-control-sm" [(ngModel)]="editedTaskLabel" />
    </div>

    <!-- Statut -->
    <div class="mb-3">
      <label class="form-label form-label-sm">Statut</label>
      <select class="form-select form-select-sm" [(ngModel)]="editedTaskStatus">
        <option *ngFor="let opt of taskStatusOptions" [ngValue]="opt.value">
          {{ opt.label }}
        </option>
      </select>
    </div>

    <!-- Dates -->
    <div class="row g-2 mb-3">
      <div class="col-6">
        <label class="form-label form-label-sm">Date de début</label>
        <input type="date" class="form-control form-control-sm" [(ngModel)]="editedStartDate" />
      </div>
      <div class="col-6">
        <label class="form-label form-label-sm">Date de fin</label>
        <input type="date" class="form-control form-control-sm" [(ngModel)]="editedEndDate" />
      </div>
    </div>

    <!-- Catégorie -->
    <div class="mb-3">
      <label class="form-label form-label-sm">Catégorie</label>
      <select class="form-select form-select-sm" [(ngModel)]="editedCategory">
        <option *ngFor="let opt of taskCategoryOptions" [ngValue]="opt.value">
          {{ opt.label }}
        </option>
      </select>
    </div>

    <!-- Phase -->
    <div class="mb-3">
      <label class="form-label form-label-sm">Phase</label>
      <select class="form-select form-select-sm" [(ngModel)]="editedPhase">
        <option *ngFor="let p of project?.phases ?? []" [ngValue]="p">
          {{ p }}
        </option>
      </select>
      <div class="form-text small">
        Changer la phase déplacera l’activité vers la cellule correspondante.
      </div>
    </div>

    <!-- ✅ Dépendances + filtre -->
    <div class="mb-0">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <label class="form-label form-label-sm mb-0">Dépendances (liens)</label>

        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-switch m-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="filterLinksInGantt"
              [(ngModel)]="filterLinksInGantt"
              (change)="onFilterLinksToggle()"
            />
            <label class="form-check-label small" for="filterLinksInGantt">
              Afficher uniquement les liens de cette activité dans le Gantt
            </label>
          </div>

          <button type="button" class="btn btn-sm btn-outline-primary" (click)="addDependencyRow()">
            + Ajouter un lien
          </button>
        </div>
      </div>

      <div *ngIf="editedDependencies.length === 0" class="text-muted small">
        Aucun lien défini pour cette activité.
      </div>

      <div *ngFor="let dep of editedDependencies; index as i" class="row g-2 align-items-end mb-2">
        <div class="col-5">
          <label class="form-label form-label-sm">Type de lien</label>
          <select class="form-select form-select-sm" [(ngModel)]="dep.type">
            <option *ngFor="let opt of dependencyTypeOptions" [ngValue]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <div class="col-6">
          <label class="form-label form-label-sm">Activité liée</label>
          <select class="form-select form-select-sm" [(ngModel)]="dep.toId">
            <option value="">— sélectionner —</option>
            <option *ngFor="let t of getLinkableTasks()" [value]="t.id">
              {{ t.label }}
            </option>
          </select>
        </div>

        <div class="col-1 d-flex justify-content-end">
          <button type="button" class="btn btn-sm btn-outline-danger" title="Supprimer" (click)="removeDependencyRow(i)">
            ×
          </button>
        </div>
      </div>

      <div class="form-text small">
        F2S = la tâche cible démarre après la fin de la source • F2F = elles finissent ensemble • S2S = elles démarrent ensemble.
      </div>
    </div>
  </div>

  <div class="modal-footer py-2">
    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="modal.dismiss()">
      Annuler
    </button>
    <button type="button" class="btn btn-sm btn-primary" (click)="saveTaskEdit(modal)">
      Enregistrer
    </button>
  </div>
</ng-template>
