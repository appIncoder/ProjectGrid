<div class="card flex-fill">
  <div class="card-body">
    <h3 class="h6 mb-3">Roadmap – Diagramme de Gantt (6 prochains mois)</h3>

    <!-- Scroll VERTICAL global uniquement -->
    <div
      style="
        max-height: 560px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        background: #fff;
      "
    >
      <!-- Layout principal : tableau (viewport) + divider + gantt (viewport) -->
      <div
        style="
          display: grid;
          grid-template-columns: {{tablePanelWidthPx}}px {{dividerW}}px 1fr;
          align-items: start;
          background: #fff;
          font-size: 0.72rem;
          line-height: 1.12;
        "
      >
        <!-- =======================
             PANNEAU TABLEAU (scroll X indépendant)
             ======================= -->
        <div
          style="
            overflow-x: auto;
            overflow-y: hidden;
          "
        >
          <!-- grille interne : 5 colonnes, largeur = contenu -->
          <div
            [style.gridTemplateColumns]="tableInnerGridTemplate"
            style="
              display: grid;
              width: max-content;
              min-width: 100%;
            "
          >
            <!-- ROW 1 tableau vide -->
            <div style="grid-column: 1 / span 5; height: 44px;"></div>

            <!-- ROW 2 : titres -->
            <div style="height: 32px; display:flex; align-items:center; min-width: 220px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">Tâches</div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">Début</div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">Fin</div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 300px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">Phase</div>
            <div style="height: 32px; display:flex; align-items:center; min-width: 120px; padding:0 8px; font-weight:600; background:#f8f9fa; border-top:1px solid #f1f3f5;">Progression</div>

            <!-- BODY -->
            <ng-container *ngFor="let row of ganttActivityRows">
              <!-- Col1 -->
              <div
                style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;"
                [style.fontWeight]="row.isHeader ? '600' : '400'"
              >
                <span *ngIf="row.isHeader" style="cursor:pointer;" (click)="onRowLabelClick(row)">
                  {{ getRowDisplayLabel(row) }}
                </span>

                <span *ngIf="!row.isHeader" style="padding-left: 12px;">
                  <span class="text-muted me-1">•</span>
                  {{ getRowTask(row.rowIndex)?.label ?? '' }}
                </span>
              </div>

              <!-- Col2 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <span *ngIf="getRowTask(row.rowIndex) as t; else dash1">{{ getTaskStartLabelForTable(t) }}</span>
                <ng-template #dash1><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col3 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <span *ngIf="getRowTask(row.rowIndex) as t; else dash2">{{ getTaskEndLabelForTable(t) }}</span>
                <ng-template #dash2><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col4 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <span *ngIf="getRowTask(row.rowIndex) as t; else dash3">{{ t.phase }}</span>
                <ng-template #dash3><span class="text-muted">—</span></ng-template>
              </div>

              <!-- Col5 -->
              <div style="height: 32px; padding:0 8px; display:flex; align-items:center; border-top:1px solid #f1f3f5;">
                <ng-container *ngIf="getRowTask(row.rowIndex) as t; else dash4">
                  <div class="d-flex align-items-center gap-2 w-100">
                    <div class="progress flex-grow-1" style="height: 8px; min-width: 70px;">
                      <div
                        class="progress-bar"
                        role="progressbar"
                        [style.width.%]="getTaskProgressPercent(t)"
                        [attr.aria-valuenow]="getTaskProgressPercent(t)"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                    <span class="small text-muted" style="min-width: 3ch; text-align:right;">
                      {{ getTaskProgressPercent(t) }}%
                    </span>
                  </div>
                </ng-container>
                <ng-template #dash4><span class="text-muted">—</span></ng-template>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- =======================
             DIVIDER (draggable)
             ======================= -->
        <div style="position: relative; height: 100%; background:#fff;">
          <div style="position:absolute; left: 4px; top:0; bottom:0; width:1px; background:#e9ecef;"></div>
          <div
            title="Glisser (min = 25% écran). Ensuite, scrolle le tableau."
            (pointerdown)="onResizeHandlePointerDown($event)"
            style="
              position:absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 10px;
              cursor: col-resize;
              background: rgba(13,110,253,0.06);
            "
          ></div>
        </div>

        <!-- =======================
             PANNEAU GANTT (scroll X indépendant)
             ======================= -->
        <div style="overflow-x: auto; overflow-y: hidden;">
          <div style="width: max-content; min-width: 100%;">
            <!-- Row 1 : milestones + phases -->
            <svg class="gantt-svg" [attr.width]="ganttViewportWidth" [attr.height]="headerRow1Height" style="display:block;">
              <g *ngFor="let ms of ganttMilestones">
                <circle
                  class="gantt-milestone-dot"
                  [attr.cx]="ganttLeftPadding + ms.monthIndex * ganttColWidth + ganttColWidth / 2"
                  [attr.cy]="18"
                  r="4"
                ></circle>
                <text
                  class="gantt-milestone-text"
                  [attr.x]="ganttLeftPadding + ms.monthIndex * ganttColWidth + ganttColWidth / 2"
                  [attr.y]="12"
                  style="font-size: 0.58rem;"
                >
                  {{ ms.label }}
                </text>
              </g>

              <g *ngFor="let band of ganttPhaseBands">
                <rect
                  class="gantt-phase-band"
                  [attr.x]="ganttLeftPadding + band.startMonthIndex * ganttColWidth"
                  [attr.y]="28"
                  [attr.width]="(band.endMonthIndex - band.startMonthIndex + 1) * ganttColWidth"
                  [attr.height]="10"
                ></rect>
                <text
                  class="gantt-phase-text"
                  [attr.x]="ganttLeftPadding + (band.startMonthIndex + band.endMonthIndex + 1) * ganttColWidth / 2"
                  [attr.y]="40"
                  style="font-size: 0.58rem;"
                >
                  {{ band.label }}
                </text>
              </g>
            </svg>

            <!-- Row 2 : mois -->
            <svg class="gantt-svg" [attr.width]="ganttViewportWidth" [attr.height]="headerRow2Height" style="display:block;">
              <g *ngFor="let month of ganttMonths; index as i">
                <text
                  class="gantt-month-text"
                  [attr.x]="ganttLeftPadding + i * ganttColWidth + ganttColWidth / 2"
                  [attr.y]="20"
                  style="font-size: 0.60rem; font-weight:600;"
                >
                  {{ month }}
                </text>
              </g>
            </svg>

            <!-- Body -->
            <svg
              class="gantt-svg"
              [attr.width]="ganttViewportWidth"
              [attr.height]="ganttBodyHeight"
              style="display:block;"
              (mousemove)="onGanttMouseMove($event)"
              (mouseup)="onGanttMouseUp($event)"
              (mouseleave)="onGanttMouseUp($event)"
            >
              <g *ngFor="let m of ganttMonths; index as colIndex">
                <line
                  class="gantt-grid-line"
                  [attr.x1]="ganttLeftPadding + colIndex * ganttColWidth"
                  [attr.y1]="0"
                  [attr.x2]="ganttLeftPadding + colIndex * ganttColWidth"
                  [attr.y2]="ganttBodyHeight"
                ></line>
              </g>

              <g *ngFor="let r of ganttActivityRows">
                <line
                  class="gantt-row-line"
                  [attr.x1]="0"
                  [attr.y1]="r.rowIndex * bodyRowHeight"
                  [attr.x2]="ganttViewportWidth"
                  [attr.y2]="r.rowIndex * bodyRowHeight"
                ></line>
              </g>

              <g *ngFor="let link of ganttLinksView">
                <path class="gantt-link" [attr.d]="link.path"></path>
              </g>

              <g *ngFor="let task of ganttTasksView">
                <rect
                  [attr.class]="task.id.startsWith('summary-') ? 'gantt-bar gantt-bar-summary' : 'gantt-bar'"
                  [attr.x]="task.x"
                  [attr.y]="task.y"
                  [attr.width]="task.width"
                  [attr.height]="task.height"
                  (mousedown)="onGanttBarMouseDown($event, task)"
                ></rect>

                <!-- Bullet gauche = move (comme avant) -->
                <circle
                  class="gantt-bar-bullet gantt-bar-bullet-start"
                  [attr.cx]="task.x"
                  [attr.cy]="task.y + task.height / 2"
                  r="4"
                  (mousedown)="onGanttBarMouseDown($event, task)"
                  (mouseenter)="showHintForTask(task, 'start')"
                  (mouseleave)="hideHints()"
                ></circle>

                <!-- ✅ Bullet droit = resize fin -->
                <circle
                  class="gantt-bar-bullet gantt-bar-bullet-end"
                  [attr.cx]="task.x + task.width"
                  [attr.cy]="task.y + task.height / 2"
                  r="4"
                  (mousedown)="onGanttBarResizeEndMouseDown($event, task)"
                  (mouseenter)="showHintForTask(task, 'end')"
                  (mouseleave)="hideHints()"
                ></circle>

                <text
                  class="gantt-bar-label"
                  [attr.x]="task.x + 4"
                  [attr.y]="task.y + task.height / 2 + 4"
                  style="font-size: 0.60rem;"
                >
                  {{ task.label }}
                </text>
              </g>

              <g *ngIf="hoverHints.start as hs">
                <rect class="gantt-hint-bg" [attr.x]="hs.x" [attr.y]="hs.y - 18" rx="3" ry="3" width="90" height="20"></rect>
                <text class="gantt-hint-text" [attr.x]="hs.x + 4" [attr.y]="hs.y - 5" style="font-size: 0.60rem;">
                  {{ hs.text }}
                </text>
              </g>

              <g *ngIf="hoverHints.end as he">
                <rect class="gantt-hint-bg" [attr.x]="he.x" [attr.y]="he.y - 18" rx="3" ry="3" width="90" height="20"></rect>
                <text class="gantt-hint-text" [attr.x]="he.x + 4" [attr.y]="he.y - 5" style="font-size: 0.60rem;">
                  {{ he.text }}
                </text>
              </g>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
